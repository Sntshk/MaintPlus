{% extends 'base.html' %}

{% block title %}Dashboard - MaintPlus{% endblock %}

{% block content %}
<style>
    .chart-card {
        background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent cards */
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
    .kpi-card {
        color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
    .chart-container {
        position: relative;
        height: 350px;
    }
    .chart-container-bar {
        position: relative;
        height: 300px;
    }
</style>

<div class="container-fluid">
    <!-- Section 1: Top-level Statistics (KPIs) -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="kpi-card bg-primary p-3">
                <h6 class="text-uppercase">Total Equipment</h6>
                <h2 class="fw-bold mb-0">{{ equipment_count }}</h2>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="kpi-card bg-success p-3">
                <h6 class="text-uppercase">Sensor Data Points</h6>
                <h2 class="fw-bold mb-0">{{ sensor_data_count }}</h2>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="kpi-card bg-info p-3">
                <h6 class="text-uppercase">Active Predictions</h6>
                <h2 class="fw-bold mb-0">{{ prediction_count }}</h2>
            </div>
        </div>
    </div>

    <!-- Section 2: Filters -->
    <div class="chart-card mb-4">
        <form method="get" id="selectionForm" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label for="equipment" class="form-label fw-bold">Equipment:</label>
                <select name="equipment" id="equipment" class="form-select" onchange="this.form.submit();">
                    <option value="">--Select Equipment--</option>
                    {% for eq in equipments %}
                        <option value="{{ eq.id }}" {% if eq.id == selected_equipment_id %}selected{% endif %}>{{ eq.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-5">
                <label for="sensor" class="form-label fw-bold">Sensor:</label>
                <select name="sensor" id="sensor" class="form-select" {% if not sensors %}disabled{% endif %} onchange="this.form.submit();">
                    <option value="">--Select Sensor--</option>
                    {% for sensor in sensors %}
                        <option value="{{ sensor.id }}" {% if sensor.id == selected_sensor_id %}selected{% endif %}>{{ sensor.sensor_type }}</option>
                    {% endfor %}
                </select>
            </div>
             <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">View</button>
            </div>
        </form>
    </div>

    <!-- Section 3: Charts -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="chart-card">
                <h5 class="card-title">Sensor Data Trend</h5>
                <div class="chart-container">
                    <canvas id="sensorTrendChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="chart-card">
                <h5 class="card-title">Equipment Distribution</h5>
                <div class="chart-container">
                    <canvas id="equipmentPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 mb-4">
            <div class="chart-card">
                <h5 class="card-title">Total Capacity (MW) by Fuel Type</h5>
                <div class="chart-container-bar">
                    <canvas id="capacityBarChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Chart 1: Sensor Trend (Line) ---
    const sensorData = JSON.parse('{{ sensor_data_json|safe }}');
    if (sensorData && sensorData.length > 0) {
        new Chart(document.getElementById('sensorTrendChart'), {
            type: 'line',
            data: { labels: sensorData.map(d => d.timestamp), datasets: [{ label: "Sensor Value", data: sensorData.map(d => d.value), borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.1)', fill: true, tension: 0.2 }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- Chart 2: Equipment Distribution (Pie) ---
    const eqTypes = JSON.parse('{{ eq_types_json|safe }}');
    const eqTypeCounts = JSON.parse('{{ eq_type_counts_json|safe }}');
    if (eqTypes && eqTypes.length > 0) {
        new Chart(document.getElementById('equipmentPieChart'), {
            type: 'pie',
            data: { labels: eqTypes, datasets: [{ label: 'Equipment Count', data: eqTypeCounts, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'], }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // --- Chart 3: Total Capacity (Bar) ---
    const capacityLabels = JSON.parse('{{ capacity_labels_json|safe }}');
    const capacityTotals = JSON.parse('{{ capacity_totals_json|safe }}');
    if (capacityLabels && capacityLabels.length > 0) {
        new Chart(document.getElementById('capacityBarChart'), {
            type: 'bar',
            data: { labels: capacityLabels, datasets: [{ label: 'Total Capacity (MW)', data: capacityTotals, backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Capacity (MW)' } } } }
        });
    }
</script>
{% endblock %}